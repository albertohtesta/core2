image: registry.michelada.io/norden/core-backend/core-backend:latest

variables:
  RAILS_ENV: "test"
  POSTGRES_PASSWORD: postgres
  DB_USER: postgres
  DB_HOST: postgres
  RABBIT_HOST: rabbitmq
  RABBIT_PORT: 15672
  POSTGRES_HOST_AUTH_METHOD: trust
  DISABLE_SPRING: "true"
  CI: 1
  REDIS_URL: 'redis://redis:6379/1'
  AWS_REGION: 'us-west-1'
  AWS_COGNITO_POOL_ID: <%= ENV["AWS_COGNITO_POOL_ID"] %>
  AWS_COGNITO_CLIENT_ID: <%= ENV["AWS_COGNITO_CLIENT_ID"] %>
  ACCESS_KEY_ID: <%= ENV["ACCESS_KEY_ID"] %>
  SECRET_ACCESS_KEY: <%= ENV["SECRET_ACCESS_KEY"] %>

cache: &global_cache
  key: $CI_COMMIT_REF_SLUG
  policy: pull-push
  paths:
    - public/
    - vendor/

services:
  - postgres
  - redis:latest
  - rabbitmq:latest

stages:
  - build
  - test
  - deploy

build:
  stage: build
  cache:
    <<: *global_cache
  script:
    - bundle install

rubocop:
  stage: test
  cache:
    <<: *global_cache
    policy: pull
  script:
    - bundle install
    - bundle exec rubocop

test:
  stage: test
  cache:
    <<: *global_cache
    policy: pull
  artifacts:
    paths:
      - 'coverage/'
  variables:
    COVERAGE: 1
  script:
    - bundle install
    - bin/rails db:create
    - bin/rails db:test:prepare
    - bin/rails test
